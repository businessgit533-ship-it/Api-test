name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions üöÄ

on: [push]

permissions:
  contents: write

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      
      - name: Check out repository code
        uses: actions/checkout@v5

      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."

      - name: POST commit payload to ServiceNow API and capture response
        run: |
          set -e
          echo "Preparing payload for ServiceNow API..."
          # Read API password from a file in the repository (secrets.txt).
          # The file should contain the password only (one line). We trim whitespace.
          if [ ! -f secrets.txt ]; then
            echo "‚ùå ERROR: secrets.txt not found."
            exit 1
          fi
          api_password=$(tr -d '\r\n' < secrets.txt)
          user="admin"

          # Determine changed files from the commit that triggered the workflow
          if [ -n "${GITHUB_SHA:-}" ]; then
            if git rev-parse "${GITHUB_SHA}^" >/dev/null 2>&1; then
              changed_files=$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}")
            else
              changed_files=$(git diff --name-only "${GITHUB_SHA}")
            fi
          else
            changed_files=$(git ls-files)
          fi

          # Build JSON payload with commit sha and contents of changed files
          payload='{ "commit_sha": "'"${GITHUB_SHA:-unknown}"'", "actor":"'"${GITHUB_ACTOR:-unknown}"'", "files": ['
          first=true
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [ ! -f "$file" ]; then
              continue
            fi
            content=$(python3 - <<'PY' "$file"
                 import sys, json
                  p = sys.argv[1]
try:
    with open(p, 'r', encoding='utf-8') as f:
        data = f.read()
except Exception:
    data = ""
print(json.dumps(data))
PY
"$file")
            if [ "$first" = true ]; then
              first=false
            else
              payload="$payload,"
            fi
            payload="$payload{\"path\":\"$(printf '%s' "$file" | sed 's/"/\\"/g')\",\"content\":$content}"
          done <<< "$changed_files"
          payload="$payload] }"

          # Send payload to ServiceNow API using basic auth (user + password from file)
          echo "Sending payload to ServiceNow API..."
          response=$(curl -s -w "\n%{http_code}" -X POST "https://dev203047.service-now.com/api/1436129/importupdateset/getxmlfile" \
            -H "Content-Type: application/json" \
            -u "${user}:${api_password}" \
            -d "$payload")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ServiceNow API HTTP status: $http_code"
          echo "Response body:"
          echo "$body"

          if [ "${http_code}" -ge 200 ] && [ "${http_code}" -lt 300 ]; then
            echo "‚úÖ Successfully sent payload to ServiceNow."
          else
            echo "‚ùå Failed to send payload to ServiceNow (status $http_code)."
            exit 1
          fi
