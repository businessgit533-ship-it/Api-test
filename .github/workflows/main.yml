name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€

on: [push]

permissions:
  contents: write

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      
      - name: Check out repository code
        uses: actions/checkout@v5

      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."

      - name: POST commit payload to ServiceNow API and capture response
        run: |
          set -e
          echo "Preparing payload for ServiceNow API..."

          # Read API password from a file in the repository (secrets.txt)
          if [ ! -f secrets.txt ]; then
            echo "âŒ ERROR: secrets.txt not found."
            exit 1
          fi
          api_password=$(tr -d '\r\n' < secrets.txt)
          user="admin"

          # Determine changed files from the commit that triggered the workflow
          if [ -n "${GITHUB_SHA:-}" ]; then
            if git rev-parse "${GITHUB_SHA}^" >/dev/null 2>&1; then
              changed_files=$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}")
            else
              changed_files=$(git diff --name-only "${GITHUB_SHA}")
            fi
          else
            changed_files=$(git ls-files)
          fi

          # Python script to safely read file content as JSON string
          script=$(cat <<'PYCODE'
import sys, json
import pathlib
path = sys.argv[1]
try:
    text = pathlib.Path(path).read_text(encoding="utf-8", errors="ignore")
except Exception:
    text = ""
print(json.dumps(text))
PYCODE
)

          # Build JSON payload with commit sha and contents of changed files
          payload='{ "commit_sha": "'"${GITHUB_SHA:-unknown}"'", "actor":"'"${GITHUB_ACTOR:-unknown}"'", "files": ['
          first=true
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue

            content=$(python3 - "$file" <<< "$script")

            if [ "$first" = true ]; then
              first=false
            else
              payload="$payload,"
            fi

            payload="$payload{\"path\":\"$(printf '%s' "$file" | sed 's/"/\\"/g')\",\"content\":$content}"
          done <<< "$changed_files"

          payload="$payload] }"

          # Send payload to ServiceNow API using basic auth
          echo "Sending payload to ServiceNow API..."
          response=$(curl -s -w "\n%{http_code}" -X POST "https://dev203047.service-now.com/api/1436129/importupdateset/getxmlfile" \
            -H "Content-Type: application/json" \
            -u "${user}:${api_password}" \
            -d "$payload")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ServiceNow API HTTP status: $http_code"
          echo "Response body:"
          echo "$body"

          if [ "${http_code}" -ge 200 ] && [ "${http_code}" -lt 300 ]; then
            echo "âœ… Successfully sent payload to ServiceNow."
          else
            echo "âŒ Failed to send payload to ServiceNow (status $http_code)."
            exit 1
          fi
