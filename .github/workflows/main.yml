name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€

on: [push]

permissions:
  contents: write

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Check out repository code
        uses: actions/checkout@v5

      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."

      - name: POST commit payload to ServiceNow API and capture response
        run: |
          set -e
          echo "Preparing payload for ServiceNow API..."

          python3 - <<'EOF'
import os, json, subprocess, base64, requests

sha = os.getenv('GITHUB_SHA', 'unknown')
actor = os.getenv('GITHUB_ACTOR', 'unknown')

# Determine changed files
try:
    result = subprocess.run(['git', 'diff', '--name-only', f'{sha}^', sha],
                            capture_output=True, text=True, check=True)
    files = [f for f in result.stdout.splitlines() if os.path.isfile(f)]
except Exception:
    # fallback: all files in repo
    files = [f for f in subprocess.run(['git', 'ls-files'], capture_output=True, text=True).stdout.splitlines()]

payload_files = []
for f in files:
    with open(f, 'r', encoding='utf-8', errors='ignore') as fh:
        payload_files.append({'path': f, 'content': fh.read()})

payload = {
    'commit_sha': sha,
    'actor': actor,
    'files': payload_files
}

payload_json = json.dumps(payload)
print("Payload prepared successfully.")

# ServiceNow API request
url = "https://dev203047.service-now.com/api/1436129/importupdateset/getxmlfile"
auth_str = "admin:R!YU5v9b=mJw"
auth_header = "Basic " + base64.b64encode(auth_str.encode()).decode()

headers = {
    "Content-Type": "application/json",
    "Authorization": auth_header
}

response = requests.post(url, headers=headers, data=payload_json)

print(f"ServiceNow API HTTP status: {response.status_code}")
print("Response body:")
print(response.text)

if 200 <= response.status_code < 300:
    print("âœ… Successfully sent payload to ServiceNow.")
else:
    print(f"âŒ Failed to send payload to ServiceNow (status {response.status_code}).")
    exit(1)
EOF
